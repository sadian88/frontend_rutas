<div class="space-y-6">
  <section class="card border border-slate-200/60">
    <form class="grid gap-4 md:grid-cols-3" [formGroup]="filtrosForm">
      <label class="text-sm font-medium text-slate-600">
        Estado
        <select
          formControlName="estado"
          class="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm text-slate-900 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-200"
        >
          <option value="">Todos</option>
          <option *ngFor="let estado of estados" [value]="estado">{{ estado }}</option>
        </select>
      </label>
      <label class="text-sm font-medium text-slate-600">
        Sede
        <select
          formControlName="sede"
          class="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm text-slate-900 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-200"
        >
          <option value="">Todas</option>
          <option *ngFor="let sede of sedes()" [value]="sede._id">{{ sede.nombre }}</option>
        </select>
      </label>
      <label class="text-sm font-medium text-slate-600">
        Conductor
        <select
          formControlName="conductor"
          class="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm text-slate-900 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-200"
        >
          <option value="">Todos</option>
          <option *ngFor="let conductor of conductores()" [value]="conductor._id">{{ conductor.nombre }}</option>
        </select>
      </label>
    </form>
  </section>
  <section class="space-y-4">
    <h2 class="text-lg font-semibold text-slate-900">Rutas</h2>
    <div class="hidden rounded-3xl border border-slate-200 bg-white p-4 shadow-card lg:block">
      <ag-grid-angular
        class="ag-theme-quartz"
        style="width: 100%; height: 520px;"
        [columnDefs]="rutasColumnDefs"
        [defaultColDef]="defaultColDef"
        [rowData]="rutas()"
        [animateRows]="true"
        (rowDoubleClicked)="onRutaRowDoubleClicked($event)"
      ></ag-grid-angular>
      <p class="mt-3 text-sm text-slate-500">Doble clic en una fila para ver el detalle de la ruta.</p>
    </div>
    <div class="space-y-3 lg:hidden">
      <article *ngFor="let ruta of rutas()" class="card border border-slate-200/60 shadow-card">
        <header class="flex items-start justify-between gap-3">
          <div>
            <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Ruta</p>
            <h3 class="text-lg font-semibold text-slate-900">{{ ruta.nombre }}</h3>
            <p class="text-xs text-slate-500">{{ ruta.sedeOrigen.nombre }} → {{ ruta.sedeDestino.nombre }}</p>
          </div>
          <span
            class="chip"
            [ngClass]="{
              'bg-emerald-100 text-emerald-700': ruta.estado === 'COMPLETADA',
              'bg-amber-100 text-amber-700': ruta.estado === 'EN_CURSO',
              'bg-rose-100 text-rose-700': ruta.estado === 'CANCELADA'
            }"
          >
            {{ ruta.estado }}
          </span>
        </header>
        <div class="mt-3 grid gap-2 text-sm text-slate-600">
          <p><span class="font-semibold">Grua:</span> {{ ruta.grua.codigo }} · {{ ruta.grua.placa }}</p>
          <p><span class="font-semibold">Conductor:</span> {{ ruta.conductor.nombre }}</p>
          <p>
            <span class="font-semibold">Fechas:</span>
            {{ ruta.fechaInicio | date: 'shortDate' }}<ng-container *ngIf="ruta.fechaFin"> - {{ ruta.fechaFin | date: 'shortDate' }}</ng-container>
          </p>
        </div>
        <div class="mt-3 grid gap-2 rounded-xl bg-slate-50/80 p-3" *ngIf="ruta.resumen">
          <div class="flex justify-between text-sm">
            <span class="text-slate-500">Gastos</span>
            <span class="font-semibold text-rose-600">{{ formatoMoneda(ruta.resumen.totalGastos) }}</span>
          </div>
          <div class="flex justify-between text-sm">
            <span class="text-slate-500">Recargas</span>
            <span class="font-semibold text-emerald-600">{{ formatoMoneda(ruta.resumen.totalRecargas) }}</span>
          </div>
          <div class="flex justify-between text-sm" [class.text-rose-600]="ruta.resumen.balance < 0" [class.text-emerald-600]="ruta.resumen.balance >= 0">
            <span class="text-slate-500">Balance</span>
            <span class="font-semibold">{{ formatoMoneda(ruta.resumen.balance) }}</span>
          </div>
        </div>
        <button type="button" class="mt-4 inline-flex w-full items-center justify-center rounded-2xl border border-primary-200 bg-primary-50 px-4 py-2 text-sm font-semibold text-primary-700" (click)="irADetalle(ruta._id)">
          Abrir detalle
        </button>
      </article>
    </div>
  </section>
  
  <section *ngIf="puedeCrear()" class="card space-y-4 border border-slate-200/60">
    <header class="space-y-2">
      <h2 class="text-xl font-semibold text-slate-900">Nueva ruta</h2>
      <p class="text-sm text-slate-500">Configura la ruta, asigna grua y conductor.</p>
    </header>
    <form class="space-y-4" [formGroup]="crearForm" (ngSubmit)="crearRuta()">
      <label class="text-sm font-medium text-slate-600">
        Nombre
        <input
          formControlName="nombre"
          placeholder="Ruta entre sedes"
          class="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-900 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-200"
        />
      </label>

      <div class="grid gap-4 md:grid-cols-2">
        <label class="text-sm font-medium text-slate-600">
          Sede origen
          <select
            formControlName="sedeOrigen"
            class="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-900 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-200"
          >
            <option value="" disabled>Selecciona una sede</option>
            <option *ngFor="let sede of sedes()" [value]="sede._id">{{ sede.nombre }}</option>
          </select>
        </label>
        <label class="text-sm font-medium text-slate-600">
          Sede destino
          <select
            formControlName="sedeDestino"
            class="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-900 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-200"
          >
            <option value="" disabled>Selecciona una sede</option>
            <option *ngFor="let sede of sedes()" [value]="sede._id">{{ sede.nombre }}</option>
          </select>
        </label>
      </div>

      <div class="grid gap-4 md:grid-cols-2">
        <label class="text-sm font-medium text-slate-600">
          Grua
          <select
            formControlName="grua"
            class="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-900 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-200"
          >
            <option value="" disabled>Selecciona una grua</option>
            <option *ngFor="let grua of gruasDisponibles()" [value]="grua._id">
              {{ grua.codigo }} - {{ grua.placa }}
            </option>
          </select>
        </label>
        <label class="text-sm font-medium text-slate-600">
          Conductor
          <select
            formControlName="conductor"
            class="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-900 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-200"
          >
            <option value="" disabled>Selecciona un conductor</option>
            <option *ngFor="let conductor of conductores()" [value]="conductor._id">
              {{ conductor.nombre }}
            </option>
          </select>
        </label>
      </div>

      <div class="grid gap-4 md:grid-cols-2">
        <label class="text-sm font-medium text-slate-600">
          Fecha inicio
          <input
            type="date"
            formControlName="fechaInicio"
            class="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-900 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-200"
          />
        </label>
        <label class="text-sm font-medium text-slate-600">
          Fecha fin
          <input
            type="date"
            formControlName="fechaFin"
            class="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-900 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-200"
          />
        </label>
      </div>

      <div class="grid gap-4 md:grid-cols-2">
        <label class="text-sm font-medium text-slate-600">
          Kilometros
          <input
            type="number"
            min="0"
            step="0.1"
            formControlName="kilometros"
            class="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-900 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-200"
          />
        </label>
        <label class="text-sm font-medium text-slate-600">
          Estado
          <select
            formControlName="estado"
            class="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-900 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-200"
          >
            <option *ngFor="let estado of estados" [value]="estado">{{ estado }}</option>
          </select>
        </label>
      </div>

      <label class="text-sm font-medium text-slate-600">
        Observaciones
        <textarea
          formControlName="observaciones"
          rows="3"
          class="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-900 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-200"
        ></textarea>
      </label>

      <button
        type="submit"
        [disabled]="cargando()"
        class="inline-flex items-center justify-center rounded-2xl bg-primary-600 px-4 py-2 text-sm font-semibold text-white shadow-lg shadow-primary-600/20 transition hover:bg-primary-700 disabled:cursor-not-allowed disabled:bg-primary-400"
      >
        {{ cargando() ? 'Registrando...' : 'Registrar ruta' }}
      </button>
    </form>
    <p *ngIf="mensaje()" class="text-sm font-medium text-emerald-600">{{ mensaje() }}</p>
  </section>


</div>

